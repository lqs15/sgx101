<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Enclave Example" &middot; SGX 101
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/sgx101/assets/css/main.css" />
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/sgx101/favicon.png" />
<link rel="shortcut icon" href="/sgx101/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="page">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/sgx101/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        SGX 101
      </a>
    </div>
    <p class="lead">The very first place to study Intel SGX.</p>
  </header>
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/sgx101/">Home</a>
  
  

  

  


  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
      <a class="page-link "
          href="/sgx101/sslab.html">SSLab</a>
    
  

  
    
      <a class="page-link "
          href="/sgx101/bootstrap.html">SGX Bootstrap</a>
    
  

  
    
      <a class="page-link "
          href="/sgx101/resources.html">Resources</a>
    
  

  
    
      <a class="page-link "
          href="/sgx101/about.html">About Us</a>
    
  


  


  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  

  <nav id="sidebar-icon-links">
  

  <a id="subscribe-link"
     class="icon" title="Subscribe" aria-label="Subscribe"
     href="/sgx101/feed.xml">
    <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <circle cx="6.18" cy="17.82" r="2.18"/>
    <path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/>
</svg>
  </a>

  
  
  
  

  
    <a id="tags-link"
       class="icon"
       title="Tags" aria-label="Tags"
       href="/sgx101/tags.html">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
    </a>
  

  
    <a id="search-link"
       class="icon"
       title="Search" aria-label="Search"
       href="/sgx101/search.html">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</svg>
    </a>
  

  <!-- Optional additional links to insert for icons links -->
</nav>

  <p>
  &copy; 2018.
  <a href="https://gts3.org/">SSLab.</a>
</p>

</div>

    <main class="container">
      <header>
  <h1 class="page-title">Enclave Example"</h1>
</header>
<div class="content">
  <p>Now let’s start with an enclave Hello world coding example.</p>

<p>Code is available under HelloEnclave <a href="https://github.com/sangfansh/SGX101_sample_code.git">here</a>. It is a simplified version of SampleEnclave example at Linux SGX SDK.</p>

<script src="https://gist.github.com/sangfansh/06404e21377ddac93883aae79ab05096.js"></script>

<p>The <code class="highlighter-rouge">App.h</code> head file defines the application we are going to create. Here, enclave initialization token is define as the <code class="highlighter-rouge">enclave.token</code> file and the signed enclave shared object after compilation will be <code class="highlighter-rouge">enclave.signed.so</code> (line 52, 53).</p>

<p>A global <code class="highlighter-rouge">sgx_enclave_id_t</code> is also declared to uniquely identify the enclave (line 55).</p>

<p>Now let’s move to <code class="highlighter-rouge">App.cpp</code>.
<script src="https://gist.github.com/sangfansh/839f2ea7e03f09876a2f2d73cfdf4753.js"></script></p>

<p>As it is in the untrusted application, we must include <code class="highlighter-rouge">sgx_urts.h</code>, the SGX untrusted runtime system, for SGX to work correctly with the application. We also include <code class="highlighter-rouge">Enclave_u.h</code>, which will include all of the ECALL proxies generated from the EDL file after compilation.</p>

<p>Line 48-150 just summarize all the possible error code caused by enclave operation.</p>

<p>The critical function here is <code class="highlighter-rouge">initialize_enclave(void)</code> at line 157. It first retrieves the launch token from previous transactions if available. If not, just use an empty buffer to record it. Then it calls <code class="highlighter-rouge">sgx_create_enclave()</code> function provided by urts library to officially initialize the enclave instance. The <code class="highlighter-rouge">sgx_create_enclave()</code> will performs an implicit ECALL. The implicit ECALL initiates enclave runtime initialization flow described in the Enclave Lifecycle tutorial. The actual enclave instance shared object will be saved as <code class="highlighter-rouge">enclave.signed.so</code>, which is signed by the CPU as indicated by the filename. And the enclave id will be saved in <code class="highlighter-rouge">global_eid</code> for future access.</p>

<p>We can ignore the <code class="highlighter-rouge">ocall_print_string()</code> function as it was in the original sample code.</p>

<p>In the main body of the application, we first initialize the enclave by calling <code class="highlighter-rouge">initialize_enclave()</code>. Then call our printf_helloworld() function, which will be discussed later.</p>

<p>Finally, we destroy the enclave instance by calling <code class="highlighter-rouge">sgx_destroy_enclave()</code> provided by urts library. It will perform the implicit ECALL that performs instructions that destry the targeted enclave.</p>

<p>Since our purpose of this example application is to print something from the enclave instead from the untrusted application directly, the enclave part should only contain the function that performs this task.</p>

<script src="https://gist.github.com/sangfansh/cfb8878e43f64c9d458162907c8424e1.js"></script>

<p>The enclave header file declares the <code class="highlighter-rouge">printf_helloworld()</code> function, which will be responsible for our purpose. This function call will be protected by the enclave so outside world won’t know the secret being processed. But for demonstration purposes, we will just print out the secret from the enclave to the screen by calling this function.</p>

<script src="https://gist.github.com/sangfansh/1bbd511db1fe67ce69953a39089d6cee.js"></script>

<p>We define the <code class="highlighter-rouge">printf_helloworld()</code> function as a part of the enclave protected code path, which just prints out <code class="highlighter-rouge">Hello World</code> to the console. In reality, the secret string should be passed into the enclave from outside world, and will be protected by the enclave. Now since the untrusted application cannot access the enclave content directly, in order for the untrusted function to call enclave functions, we have to rely on the assistance of proxy functions, which will be generated by the Edger8r tool from EDL file after compilation. </p>

<p>The proxy functions are responsible for:</p>
<ul>
  <li>Marshaling data into and out of the enclave</li>
  <li>Placing the return value of the real ECALL or OCALL in an address referenced by a pointer parameter</li>
  <li>Returning the success or failure of the ECALL or OCALL itself as an <code class="highlighter-rouge">sgx_status_t</code> value</li>
</ul>

<p>Note that this means each ECALL or OCALL has potentially two return values. There’s the success of the ECALL or OCALL itself, meaning, were we able to successfully enter or exit the enclave, and then the return value of the function being called in the ECALL or OCALL.</p>

<p>Additional arguments will added to the parameter list for each proxy function and the proxy functions now return a type of <code class="highlighter-rouge">sgx_status_t</code> instead of the original return types. The first additional parameter is the enclave identifier, eid. The second argument to the proxy function is a pointer to an address that will store the return value from the original enclave function if it has a return value. Since our <code class="highlighter-rouge">printf_helloworld()</code> function does not have a return value, the proxy function generated for it will look like 
<script src="https://gist.github.com/sangfansh/c8bfa25fdaf73776480f3f0bee00c712.js"></script></p>

<p>We can verify that after compiling the whole project.</p>

<p>Therefore, in order to let the <code class="highlighter-rouge">Edger8r</code> generate the corresponding proxy functions, we put our function <code class="highlighter-rouge">printf_helloworld()</code> in the trusted section of <code class="highlighter-rouge">Enclave.edl</code>. </p>

<script src="https://gist.github.com/sangfansh/35a96c020d08a57d023eb7f8454530f1.js"></script>

<p>By now, the whole hello world application has acquired all the required parts and should be ready to go.</p>

<p>Compile the project by typing <code class="highlighter-rouge">make</code> inside project directory. It should output something like this:
<img src="/sgx101/assets/pics/enclave_example.png" alt="Enclave Example" /></p>

<p>Then execute the application by typing <code class="highlighter-rouge">./app</code>. <code class="highlighter-rouge">Hello World</code> should be printed to the console. And the message is coming form within the enclave to the outside world!</p>

<p>We can verify the proxy function generated in <code class="highlighter-rouge">Enclave_u.c</code> has the signature mentioned above (line 21).</p>

<script src="https://gist.github.com/sangfansh/1439a803558f63671a35b59168406786.js"></script>

<p>Congratulations you have created your first enclave application!</p>

</div>

    </main>

    <!-- Optional footer content -->

  </body>
</html>
