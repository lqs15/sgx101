<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Password Wallet &middot; SGX 101
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/sgx101/assets/css/main.css" />
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/sgx101/favicon.png" />
<link rel="shortcut icon" href="/sgx101/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="page">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/sgx101/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        SGX 101
      </a>
    </div>
    <p class="lead">The very first place to study Intel SGX.</p>
  </header>
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/sgx101/">Home</a>
  
  

  

  


  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
      <a class="page-link "
          href="/sgx101/sslab.html">SSLab</a>
    
  

  
    
      <a class="page-link "
          href="/sgx101/bootstrap.html">SGX Bootstrap</a>
    
  

  
    
      <a class="page-link "
          href="/sgx101/resources.html">Resources</a>
    
  

  
    
      <a class="page-link "
          href="/sgx101/about.html">About Us</a>
    
  


  


  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  

  <nav id="sidebar-icon-links">
  

  <a id="subscribe-link"
     class="icon" title="Subscribe" aria-label="Subscribe"
     href="/sgx101/feed.xml">
    <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <circle cx="6.18" cy="17.82" r="2.18"/>
    <path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/>
</svg>
  </a>

  
  
  
  

  
    <a id="tags-link"
       class="icon"
       title="Tags" aria-label="Tags"
       href="/sgx101/tags.html">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
    </a>
  

  
    <a id="search-link"
       class="icon"
       title="Search" aria-label="Search"
       href="/sgx101/search.html">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</svg>
    </a>
  

  <!-- Optional additional links to insert for icons links -->
</nav>

  <p>
  &copy; 2018.
  <a href="https://gts3.org/">SSLab.</a>
</p>

</div>

    <main class="container">
      <header>
  <h1 class="page-title">Password Wallet</h1>
</header>
<div class="content">
  <p>Now let’s build a linux version of Password Manager application. Project code is available <a href="https://github.com/sangfansh/SGX101_sample_code">here</a>.</p>

<p>Original unmodified version is available <a href="https://github.com/asonnino/sgx-wallet">here</a>.</p>

<hr />

<p>The purpose of this application is to <strong>create a password wallet that can safely store your passwords and display them when requested</strong>. By implementing the wallet with SGX enclave protection, you are guaranteed to be able to securely create a wallet and manage the items inside it. The wallet will be sealed using SGX so that data are protected on disk and unsealed before any operation onto the wallet. Sealed wallet will be saved as filename “wallet.seal”.</p>

<p>The application starts with <code class="highlighter-rouge">app/app.cpp</code>.</p>

<script src="https://gist.github.com/sangfansh/0a0a1b03c4f3dca884975a521ba3773c.js"></script>

<p>First we start the application by creating an enclave for future secret operations. After successfully initializing the enclave, we will construct a console interface for users to interact with the application. Here we use getopt() to generate a console user interface with various options including:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>h: help

n: create new wallet

p: master password

c: change master password

s: show wallet

a: add item

x: item’s title

y: item’s username

z: item’s password

r: remove item

And exception handling
</code></pre></div></div>

<p>How to use the Command Line Interface:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Show help:

    sgx-wallet -h

Show version:

    sgx-wallet -v

Create a new wallet with master-password &lt;master-passowrd&gt;:

    sgx-wallet -n master-password

Change current master-password to &lt;new-master-password&gt;:

    sgx-wallet -p master-password -c new-master-password

Add a new item to the wallet with title &lt;item_title&gt;, username &lt;item_username&gt;, and password &lt;item_password&gt;:

    sgx-wallet -p master-password -a -x item_title -y item_username -z item_password

Remove item at index &lt;item_index&gt; from the wallet:

    sgx-wallet -p master-password -r item_index
</code></pre></div></div>

<p>We set flags for each of the operations and perform actions according to the options given by the user. After each interaction with the user, the enclave will be destroyed and the application will safely exit.</p>

<p>In this application, a password <code class="highlighter-rouge">Wallet</code> is just a container of password <code class="highlighter-rouge">Items</code>. Both <code class="highlighter-rouge">Item</code> and <code class="highlighter-rouge">Wallet</code> objects are defined inside <code class="highlighter-rouge">wallet.h</code>. An Item has a user defined name, a username field and the corresponding password. A Wallet also has a size to indicate the number of Items it has, and a <code class="highlighter-rouge">master_password</code> which is requested before modifying Wallet contents.</p>

<script src="https://gist.github.com/sangfansh/496ed4da9dafe89ef340fa714f37bdd6.js"></script>

<p>Now let’s design the <strong>trusted and untrusted boundary</strong> of the application. In other words, we need to decide which functions will go to the trusted part (run inside enclave) and the untrusted part (run outside enclave).</p>

<p>In order to keep the amount of operations inside the enclave <strong>minimal</strong>, we only put functions with sensitive operations inside enclave. In addition, functions that utilizes system calls that are not supported by SGX enclave, such as file IO, will have to be put in the untrusted part and accessed using <code class="highlighter-rouge">OCalls</code>.</p>

<p>We conclude that any operation that is directly related to the wallet itself and the items inside should be put inside the enclave, including creating and showing the wallet, changing the wallet master password, and adding or removing password items.</p>

<p>Other operations such as saving the sealed wallet to and loading the wallet form the disk require file IO, which is not supported by SGX enclave, should be put outside the enclave.</p>

<p>Therefore, we will provide following functions to the user:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>trusted {

    public int ecall_create_wallet();
    public int ecall_show_wallet();
    public int ecall_change_master_password();
    public int ecall_add_item();
    public int ecall_remove_item();

};

untrusted {

    int ocall_save_wallet();
    int ocall_load_wallet();r
    int ocall_is_wallet();

};
</code></pre></div></div>

<p>The EDL file therefore looks like this:</p>

<script src="https://gist.github.com/sangfansh/79fa8d6797e4f35b5df2afe6a7794f2a.js"></script>

<p><code class="highlighter-rouge">int ecall_create_wallet(const char* master_password)</code>:
<script src="https://gist.github.com/sangfansh/025f2160bbf65b6b4453aca34b55661a.js"></script></p>

<p>This function will take a user input <code class="highlighter-rouge">master_password</code> and create an empty <code class="highlighter-rouge">Wallet</code> for the user if no Wallet has already existed. First it check the master password against the predefined password policy. Then it checks whether a Wallet already exists. If not, a new Wallet object will be initialized with size 0 and the master password provided. Then the wallet is sealed using SGX sealing function and saved to disk as <code class="highlighter-rouge">wallet.seal</code>.</p>

<p><code class="highlighter-rouge">int ecall_show_wallet(const char* master_password, wallet_t* wallet, size_t wallet_size)</code>:
<script src="https://gist.github.com/sangfansh/59f56aa6dcb11da4c89af22de5731094.js"></script></p>

<p>This function will load the wallet from <code class="highlighter-rouge">wallet.seal</code> if exists and unseal it inside the enclave. If the master password provided by the user matches the one in the wallet, the wallet will be returned to the untrusted application to display.</p>

<p><code class="highlighter-rouge">int ecall_change_master_password(const char* old_password, const char* new_password)</code>:
<script src="https://gist.github.com/sangfansh/2935483b5bf9760fd94648116926df8b.js"></script></p>

<p>This function will take in the old password of the wallet and a new password to update. The new password will first be validated against the password policy. Then the existing wallet will be loaded and unsealed inside the enclave. If the old password matches the one inside the wallet, the password field will be updated with the new password. Finally, the wallet will be sealed again and saved to the disk.</p>

<p><code class="highlighter-rouge">int ecall_add_item(const char* master_password, const item_t* item, const size_t item_size)</code>:
<script src="https://gist.github.com/sangfansh/22f356186a48f8b1e980b7ca6d41e5ad.js"></script></p>

<p>This function will load and unseal the wallet inside the enclave first. Then if the master password matches the one inside the wallet, the new password item provided by the user will be added to the wallet. Finally, the wallet will be sealed again and saved to the disk.</p>

<p><code class="highlighter-rouge">int ecall_remove_item(const char* master_password, const int index)</code>:
<script src="https://gist.github.com/sangfansh/11ce84887033fdb4a85f28f7b6cad6b3.js"></script></p>

<p>The function takes in the master password of the wallet and the index of the item to be deleted from the wallet. First it checks the index provided does not exceed the maximum number of items a wallet can contain. Then it loads and unseals the wallet inside the enclave. If the provided master password matches the one inside the wallet, the item at the given index is removed. Finally the wallet is sealed again and saved to the disk.</p>

<p><code class="highlighter-rouge">int ocall_save_wallet(const uint8_t* sealed_data, const size_t sealed_size)</code>:
<script src="https://gist.github.com/sangfansh/9ee6780c4dcb5d18f9b5e32412dcd0d7.js"></script></p>

<p>This function uses the standard file IO to save the sealed wallet to disk as <code class="highlighter-rouge">wallet.seal</code>.</p>

<p><code class="highlighter-rouge">int ocall_load_wallet(uint8_t* sealed_data, const size_t sealed_size)</code>:
<script src="https://gist.github.com/sangfansh/83b2908ea2945d8304844cb56a247037.js"></script></p>

<p>This function reads in the file <code class="highlighter-rouge">wallet.seal</code> into the application’s memory.</p>

<p><code class="highlighter-rouge">int ocall_is_wallet(void)</code>:
<script src="https://gist.github.com/sangfansh/3f8a96c309c7264745d8cf26c785c7bb.js"></script></p>

<p>This function verifies whether a wallet <code class="highlighter-rouge">wallet.seal</code> already exists on the disk.</p>

<p>Other utility functions, such as displaying the wallet with format and providing explanations of the error code, are defined in <code class="highlighter-rouge">app/utils.cpp</code>. A <code class="highlighter-rouge">show_help</code> function is also defined here so that when user gives <code class="highlighter-rouge">-h</code> option in the console interface, a usage guide will be prompted.
<script src="https://gist.github.com/sangfansh/5e11a0bd83d50cfae93969d0d4d2c6f9.js"></script></p>

<p>In order to build and run the password wallet, first <code class="highlighter-rouge">cd sgx-wallet</code>, then <code class="highlighter-rouge">make</code>. Type <code class="highlighter-rouge">./sgx-wallet -options</code> to run the application. Sample output looks like:</p>

<p><img src="/sgx101/assets/pics/wallet.png" alt="wallet" /></p>

</div>

    </main>

    <!-- Optional footer content -->

  </body>
</html>
